<!DOCTYPE html>
<html lang="id">
<head>
  <meta charset="UTF-8">
  <title>FIDO2 Register & Login</title>
  <style>
    /* ... (CSS tidak berubah) ... */
    body { font-family: Arial, sans-serif; margin: 2rem; background: #f8fafc; }
    h1 { color: #1e293b; font-size: 1.8rem; }
    h2 { font-size: 1.2rem; display: flex; justify-content: space-between; align-items: center; }
    input { padding: 8px; margin-right: 10px; border: 1px solid #ccc; border-radius: 4px; }
    button { padding: 8px 12px; margin-right: 10px; cursor: pointer; border: none; border-radius: 4px; background: #2563eb; color: white; }
    button:disabled { background: #94a3b8; cursor: not-allowed; }
    .clear-btn { background-color: #ef4444; font-size: 0.8rem; padding: 4px 8px; }
    #username-status { font-size: 0.9rem; margin-left: 5px; }
    .log-box { margin-top: 10px; padding: 10px; border: 1px solid #ccc; background: #f1f5f9; min-height: 120px; font-family: monospace; white-space: pre-wrap; border-radius: 4px; line-height: 1.5; }
    .success { color: green; }
    .error { color: red; }
    .info { color: #334155; }
    .link-container { margin-top: 25px; padding: 15px; background-color: #fff; border: 1px dashed #ccc; border-radius: 5px; text-align: center; }
    .malware-log { border-color: #16a34a; background: #f0fdf4; }
  </style>
</head>
<body>
  <h1>FIDO2 Register & Login</h1>

  <div>
    <input id="username" placeholder="Masukkan username" />
    <span id="username-status"></span>
    <br><br>
    <button id="registerBtn" onclick="startRegister()">Daftar</button>
    <button id="loginBtn" onclick="startLogin()">Login</button>
  </div>
  
  <div class="link-container">
    <a href="/login-password.html">Simulasi Login dengan Password</a>
  </div>

  <h2>
    <span>Status & Alur Kerja FIDO2</span>
    <button class="clear-btn" onclick="clearLogs('fido_demo_log', 'log', 'Menunggu aksi...')">Hapus Log</button>
  </h2>
  <div id="log" class="log-box">Menunggu aksi...</div>
  
  <h2>
    <span>üëπ Log Simulasi Malware (Keylogger)</span>
    <button class="clear-btn" onclick="clearLogs('malware_log_safe', 'malware-log', 'Malware aktif...')">Hapus Log</button>
  </h2>
  <div id="malware-log" class="log-box malware-log">Malware aktif...</div>

  <script src="app.js"></script>
  <script>
    // --- KODE LOG BARU (BISA DIGUNAKAN KEMBALI) ---
    function loadLogs(key, elementId, defaultText) {
      const element = document.getElementById(elementId);
      const savedLogs = sessionStorage.getItem(key);
      if (savedLogs) {
        element.innerHTML = savedLogs;
        element.scrollTop = element.scrollHeight;
      } else {
        element.innerHTML = defaultText;
      }
    }

    function clearLogs(key, elementId, defaultText) {
        sessionStorage.removeItem(key);
        document.getElementById(elementId).innerHTML = defaultText;
        alert("Log telah dihapus.");
    }
    // ---------------------------------------------

    // --- KODE LOG STATUS FIDO2 ---
    const logEl = document.getElementById("log");
    const FIDO_LOG_KEY = 'fido_demo_log';
    function logMessage(msg, type = "info") {
      if (logEl.innerHTML === "Menunggu aksi...") logEl.innerHTML = "";
      const line = document.createElement("div");
      line.className = type;
      line.textContent = `[${new Date().toLocaleTimeString()}] ${msg}`;
      logEl.appendChild(line);
      logEl.scrollTop = logEl.scrollHeight;
      sessionStorage.setItem(FIDO_LOG_KEY, logEl.innerHTML);
    }
    // ----------------------------

    // --- KODE SIMULASI MALWARE ---
    const malwareLogEl = document.getElementById('malware-log');
    const MALWARE_LOG_KEY = 'malware_log_safe';
    function logMalwareAttempt() {
        const capturedUsername = usernameInput.value;
        const time = `[${new Date().toLocaleTimeString()}]`;
        
        if (malwareLogEl.innerHTML.includes("Malware aktif...")) {
            malwareLogEl.innerHTML = ""; // Hapus pesan default
        }
        
        const usernameLog = document.createElement("div");
        usernameLog.textContent = `${time} Username yang dicuri: ${capturedUsername}`;
        
        const passwordLog = document.createElement("div");
        passwordLog.textContent = `${time} Password yang dicuri: `;

        malwareLogEl.appendChild(usernameLog);
        malwareLogEl.appendChild(passwordLog);
        malwareLogEl.appendChild(document.createElement("hr"));
        
        malwareLogEl.scrollTop = malwareLogEl.scrollHeight;
        sessionStorage.setItem(MALWARE_LOG_KEY, malwareLogEl.innerHTML);
    }
    // ----------------------------

    // --- KODE UTAMA HALAMAN ---
    const usernameInput = document.getElementById("username");
    const statusEl = document.getElementById("username-status");
    const registerBtn = document.getElementById("registerBtn");
    
    // ... (kode pengecekan username tidak berubah) ...
    let checkTimer;
    usernameInput.addEventListener("input", () => {
      const username = usernameInput.value.trim();
      clearTimeout(checkTimer);
      statusEl.textContent = "‚è≥ Memeriksa...";
      statusEl.className = "info";
      registerBtn.disabled = true;

      if (username.length === 0) {
        statusEl.textContent = "‚ùå Tidak boleh kosong";
        statusEl.className = "error";
        return;
      }

      checkTimer = setTimeout(async () => {
        try {
          const res = await fetch(`/check-username/${encodeURIComponent(username)}`);
          const data = await res.json();
          if (data.available) {
            statusEl.textContent = "‚úÖ Username tersedia";
            statusEl.className = "success";
            registerBtn.disabled = false;
          } else {
            statusEl.textContent = "‚ùå Username sudah dipakai";
            statusEl.className = "error";
            registerBtn.disabled = true;
          }
        } catch (e) {
          statusEl.textContent = "‚ö†Ô∏è Gagal mengecek";
          statusEl.className = "error";
        }
      }, 400);
    });

    async function startRegister() {
      logMalwareAttempt(); // <-- Log malware saat aksi dimulai
      const username = usernameInput.value.trim().toLowerCase();
      // ... (sisa kode)
      if (!username) {
        logMessage("‚ùå Username tidak boleh kosong", "error");
        return;
      }
      try {
        await register(username, logMessage);
      } catch (e) {
        logMessage("‚ùå Register error: " + e.message, "error");
      }
    }

    async function startLogin() {
      logMalwareAttempt(); // <-- Log malware saat aksi dimulai
      const username = usernameInput.value.trim().toLowerCase();
      // ... (sisa kode)
      if (!username) {
        logMessage("‚ùå Username tidak boleh kosong", "error");
        return;
      }
      try {
        await login(username, logMessage);
      } catch (e) {
        logMessage("‚ùå Login error: " + e.message, "error");
      }
    }

    window.alert = function(msg) {
      if (msg.startsWith("‚úÖ")) logMessage(msg, "success");
      else logMessage(msg, "error");
    };

    // Panggil loadLogs() untuk kedua log saat halaman dibuka
    loadLogs(FIDO_LOG_KEY, 'log', 'Menunggu aksi...');
    loadLogs(MALWARE_LOG_KEY, 'malware-log', 'Malware aktif...');
  </script>
</body>
</html>